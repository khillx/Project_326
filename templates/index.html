<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>What Should I Play?</title>
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gamecard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/button.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}"> <!-- New file for modals -->
</head>

<body>
    <!-- Header: Title -->
    <header>
        <h1 class="page-title">What Should I Play?</h1>
        <div>
            <button class="profile-btn" onclick="openProfile()">Profile</button>
            <button class="profile-btn rate-btn" onclick="openRateModal()">Rate & Review</button>
        </div>
    </header>

    <main>
        <!-- GAME CARD -->
        <section class="gamecard">
            <!-- Game Card: Game Title -->
            <div class="game-title" id="game-title">Hollow Knight: Silksong</div>
            
            <!-- Game Card: Image -->
            <img src="{{ url_for('static', filename='images/hollowknight.png') }}" class="game-image" id="game-image" alt="Game Image"> 

            <!-- Game Card: Game Description -->
            <div class="game-description" id="game-description">
                <p>Discover a vast, haunted kingdom in Hollow Knight: Silksong! Explore, fight and survive as you ascend to the peak of a land ruled by silk and song.</p>
            </div>

            <!-- Game Card: Game Info Section -->
            <div class="game-info" id="game-info">
                <p><strong>Price:</strong> $29.99</p>
                <p><strong>Reviews:</strong> Very Positive</p>
                <p><strong>Release Date:</strong> 2025-10-20</p>
                <p><strong>Genre:</strong> Action, Adventure, Indie</p>
            </div>

            <!-- Game Card: Next Game Button -->
            <div class="game-button">
                <button onclick="getRandomGame()">Random Game</button>
                <button onclick="markPlayed()">I Played This</button>
            </div>
        </section>
        
        <!-- FILTERS -->
        <section class="filters">
            <!-- Filters: Options -->
            <h3>Filter by...</h3>
            <label><input type="checkbox" name="genre" value="Action"> Action</label>
            <label><input type="checkbox" name="genre" value="Adventure"> Adventure</label>
            <label><input type="checkbox" name="genre" value="Indie"> Indie</label>
            <label><input type="checkbox" name="genre" value="RPG"> RPG</label>
            <label><input type="checkbox" name="genre" value="Strategy"> Strategy</label>
            <label><input type="checkbox" name="genre" value="Puzzle"> Puzzle</label> 
            <label><input type="checkbox" name="genre" value="Singleplayer"> Singleplayer</label> 
            <label><input type="checkbox" name="genre" value="Sports"> Sports</label> 
                
            <!-- Filters: Button -->
            <div class="filter-button">
                <button onclick="applyFilters()">Apply Filter(s)</button>
                <button onclick="resetFilters()">Reset Filter(s)</button>
            </div>
        </section>
    </main>

    <!-- RATE & REVIEW MODAL -->
    <div id="rate-modal" class="modal">
        <div class="modal-content">
            <h2>Rate & Review <span id="modal-game-title"></span></h2>
            <h3>How would you rate this game?</h3>
            <div class="stars-container">
                <span onclick="setRating(1)" class="star">★</span>
                <span onclick="setRating(2)" class="star">★</span>
                <span onclick="setRating(3)" class="star">★</span>
                <span onclick="setRating(4)" class="star">★</span>
                <span onclick="setRating(5)" class="star">★</span>
            </div>
            <h3>Write a Review (Optional)</h3>
            <textarea class="review-text" id="modal-review-text" placeholder="Share your thoughts..."></textarea>
            <button class="modal-btn" onclick="submitRating()">Submit Rating</button>
            <button class="close-btn" onclick="closeRateModal()">Close</button>
            <p id="modal-status"></p>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h2>Profile Settings</h2>
            <h3>Steam Import</h3>
            <input type="text" id="steam-id" placeholder="SteamID64 or vanity URL">
            <button class="modal-btn" onclick="importSteam()">Link Steam</button>
            <p id="steam-status"></p>
            <h3>Game Preferences</h3>
            <div class="checkbox-group">
                <label><input type="checkbox" value="Action"> Action</label>
                <label><input type="checkbox" value="Adventure"> Adventure</label>
                <label><input type="checkbox" value="Indie"> Indie</label>
                <label><input type="checkbox" value="RPG"> RPG</label>
                <label><input type="checkbox" value="Strategy"> Strategy</label>
                <label><input type="checkbox" value="Puzzle"> Puzzle</label>
            </div>
            <button class="modal-btn" onclick="savePreferences()">Save</button>
            <h3>Account</h3>
            <input type="text" id="gamer-tag" placeholder="Gamer Tag">
            <button class="modal-btn" onclick="saveAccount()">Update</button>
            <button class="close-btn" onclick="closeProfile()">Close</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        let currentGame = null;
        let currentRating = 0;
        let playedGames = JSON.parse(localStorage.getItem("played")) || [];
        let reviews = JSON.parse(localStorage.getItem("reviews")) || {};
        let user = JSON.parse(localStorage.getItem("user")) || { gamer_tag: "Guest" };

        async function getRandomGame() {
            const res = await fetch("/game/random");
            const game = await res.json();
            if (game.error) { alert(game.error); return; }
            displayGame(game);
        }

        function displayGame(game) {
            currentGame = game;
            document.getElementById("game-title").textContent = game.name || "Hollow Knight: Silksong";
            document.getElementById("game-image").src = game.image || "{{ url_for('static', filename='images/hollowknight.png') }}";
            document.getElementById("game-description").innerHTML = `<p>${game.short_description || "Discover a vast, haunted kingdom in Hollow Knight: Silksong! Explore, fight and survive as you ascend to the peak of a land ruled by silk and song."}</p>`;
            document.getElementById("game-info").innerHTML = `
                <p><strong>Price:</strong> ${game.price || "$29.99"}</p>
                <p><strong>Reviews:</strong> ${game.review_summary || "Very Positive"}</p>
                <p><strong>Release Date:</strong> ${game.release_date || "2025-10-20"}</p>
                <p><strong>Genre:</strong> ${game.genres?.join(", ") || "Action, Adventure, Indie"}</p>
            `;

            const saved = reviews[game.appid];
            if (saved) {
                document.getElementById("modal-status").textContent = `You rated this ${saved.rating} stars!`;
            }
        }

        function markPlayed() {
            if (currentGame && !playedGames.includes(currentGame.appid)) {
                playedGames.push(currentGame.appid);
                localStorage.setItem("played", JSON.stringify(playedGames));
                alert("Marked as played!");
            }
        }

        // === RATING MODAL ===
        function openRateModal() {
            if (!currentGame) return;
            document.getElementById("modal-game-title").textContent = currentGame.name;
            document.getElementById("rate-modal").style.display = "flex";
            resetStars();
            const saved = reviews[currentGame.appid];
            if (saved) {
                setRating(saved.rating);
                document.getElementById("modal-review-text").value = saved.text || "";
            } else {
                document.getElementById("modal-review-text").value = "";
            }
        }

        function closeRateModal() {
            document.getElementById("rate-modal").style.display = "none";
        }

        function setRating(rating) {
            currentRating = rating;
            const stars = document.querySelectorAll("#rate-modal .star");
            stars.forEach((star, i) => {
                star.classList.toggle("active", i < rating);
            });
        }

        function resetStars() {
            currentRating = 0;
            document.querySelectorAll("#rate-modal .star").forEach(s => s.classList.remove("active"));
        }

        function submitRating() {
            if (currentRating === 0) {
                alert("Please select a star rating!");
                return;
            }
            const text = document.getElementById("modal-review-text").value.trim();
            reviews[currentGame.appid] = { rating: currentRating, text };
            localStorage.setItem("reviews", JSON.stringify(reviews));
            document.getElementById("modal-status").textContent = "Rating saved!";
            markPlayed();
        }

        // === FILTERS ===
        function applyFilters() { alert("Filters applied!"); getRandomGame(); }
        function resetFilters() { document.querySelectorAll("input[type=checkbox], select").forEach(el => el.type === "checkbox" ? el.checked = false : el.value = ""); }

        // === PROFILE ===
        function openProfile() {
            document.getElementById("profile-modal").style.display = "flex";
            document.getElementById("steam-id").value = user.steam_id || "";
            document.getElementById("gamer-tag").value = user.gamer_tag;
        }
        function closeProfile() { document.getElementById("profile-modal").style.display = "none"; }

        function importSteam() {
            const id = document.getElementById("steam-id").value.trim();
            if (id) { user.steam_id = id; localStorage.setItem("user", JSON.stringify(user)); }
            document.getElementById("steam-status").textContent = id ? "Steam linked!" : "";
        }
        function savePreferences() { alert("Preferences saved!"); }
        function saveAccount() {
            const tag = document.getElementById("gamer-tag").value.trim();
            if (tag) { user.gamer_tag = tag; localStorage.setItem("user", JSON.stringify(user)); alert("Gamer tag updated!"); }
        }

        window.onload = getRandomGame;
    </script>
</body>
</html>