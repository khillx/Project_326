<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>What Should I Play?</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gamecard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/button.css') }}">

    <style>
        :root {
            --primary: #4a6fa5;
            --card-bg: #1a2332;
            --text: #e0e6ed;
            --border: #2a3447;
            --accent: #64b5f6;
        }
        body { background: #0f1621; color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #1a2332; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .page-title { font-size: 22px; font-weight: 600; margin: 0; color: var(--accent); }
        .profile-btn button, .rate-btn button { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 8px; font-weight: 500; cursor: pointer; }

        main { display: flex; gap: 25px; padding: 25px; flex-wrap: wrap; }
        .gamecard, .filters { background: var(--card-bg); padding: 25px; border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
        .gamecard { flex: 2; min-width: 380px; display: flex; flex-direction: column; }
        .filters { flex: 1; min-width: 260px; }

        .game-title { font-size: 26px; font-weight: 700; margin: 0 0 16px; color: var(--accent); }
        .game-image { width: 100%; border-radius: 12px; margin-bottom: 18px; box-shadow: 0 6px 14px rgba(0,0,0,0.5); }

        .game-info { margin: 18px 0; font-size: 15px; line-height: 1.7; }
        .game-info p { margin: 7px 0; }
        .game-info strong { color: #90caf9; }

        .game-button { display: flex; gap: 12px; margin: 20px 0; }
        .game-button button { flex: 1; padding: 14px; border-radius: 10px; font-weight: 600; background: #3a506b; color: white; border: none; cursor: pointer; }
        .game-button button:hover { background: var(--primary); }

        .filter-group { margin: 18px 0; }
        .filter-group label { color: #b0bec5; font-size: 14px; font-weight: 500; }
        .checkbox-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0; }
        .checkbox-group label { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #e0e6ed; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 550px; border-radius: 16px; padding: 30px; box-shadow: 0 12px 40px rgba(0,0,0,0.7); color: white; max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { margin: 0 0 22px; color: var(--accent); text-align: center; font-size: 26px; }
        .modal-content h3 { margin: 24px 0 12px; color: #90caf9; font-size: 19px; }

        /* STAR RATING */
        .stars-container { display: flex; justify-content: center; gap: 12px; font-size: 3rem; margin: 15px 0; }
        .star { cursor: pointer; color: #555; transition: color 0.2s; }
        .star:hover, .star.active { color: #ffd700; }

        .review-text { width: 100%; padding: 14px; margin: 12px 0; border-radius: 10px; background: #2a3447; border: 1px solid #3a445f; color: white; min-height: 100px; resize: vertical; font-size: 15px; }

        .modal button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; background: var(--primary); border: none; color: white; font-weight: 600; cursor: pointer; }
        .modal .close-btn { background: #455a7a; margin-top: 20px; }
    </style>
</head>
<body>
    <header>
        <h1 class="page-title">What Should I Play?</h1>
        <div style="display: flex; gap: 10px;">
            <div class="rate-btn"><button onclick="openRateModal()">Rate & Review</button></div>
            <div class="profile-btn"><button onclick="openProfile()">Profile</button></div>
        </div>
    </header>

    <main>
        <!-- GAME CARD -->
        <section class="gamecard">
            <h2 class="game-title" id="game-title">Loading...</h2>
            <img src="" class="game-image" id="game-image" alt="Game">

            <!-- GAME INFO -->
            <div class="game-info" id="game-info">
                <p><strong>Price:</strong> <span id="price">N/A</span></p>
                <p><strong>Release:</strong> <span id="release">N/A</span></p>
                <p><strong>Reviews:</strong> <span id="review_summary">N/A</span></p>
                <p><strong>Genres:</strong> <span id="genres">N/A</span></p>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="game-button">
                <button onclick="getRandomGame()">Random Game</button>
                <button onclick="markPlayed()">I Played This</button>
            </div>
        </section>

        <!-- FILTERS -->
        <section class="filters">
            <h3>Filter by...</h3>

            <div class="filter-group">
                <label>Genre</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" value="Action"> Action</label>
                    <label><input type="checkbox" value="Adventure"> Adventure</label>
                    <label><input type="checkbox" value="Indie"> Indie</label>
                    <label><input type="checkbox" value="RPG"> RPG</label>
                    <label><input type="checkbox" value="Strategy"> Strategy</label>
                    <label><input type="checkbox" value="Puzzle"> Puzzle</label>
                    <label><input type="checkbox" value="Singleplayer"> Singleplayer</label>
                    <label><input type="checkbox" value="Sports"> Sports</label>
                </div>
            </div>

            <div class="filter-group">
                <label>Age Rating</label>
                <select id="age-filter">
                    <option value="">Any</option>
                    <option value="E">Everyone (E)</option>
                    <option value="T">Teen (T)</option>
                    <option value="M">Mature (M)</option>
                </select>
            </div>

            <div class="filter-button">
                <button onclick="applyFilters()">Apply</button>
                <button onclick="resetFilters()">Reset</button>
            </div>
        </section>
    </main>

    <!-- RATE & REVIEW MODAL -->
    <div id="rate-modal" class="modal">
        <div class="modal-content">
            <h2>Rate & Review <span id="modal-game-title"></span></h2>

            <h3>How would you rate this game?</h3>
            <div class="stars-container">
                <span onclick="setRating(1)" class="star">★</span>
                <span onclick="setRating(2)" class="star">★</span>
                <span onclick="setRating(3)" class="star">★</span>
                <span onclick="setRating(4)" class="star">★</span>
                <span onclick="setRating(5)" class="star">★</span>
            </div>

            <h3>Write a Review (Optional)</h3>
            <textarea class="review-text" id="modal-review-text" placeholder="Share your thoughts..."></textarea>

            <button onclick="submitRating()">Submit Rating</button>
            <button class="close-btn" onclick="closeRateModal()">Close</button>
            <p id="modal-status" style="margin-top:10px; color:#81c784;"></p>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h2>Profile Settings</h2>

            <h3>Steam Import</h3>
            <input type="text" id="steam-id" placeholder="SteamID64 or vanity URL">
            <button onclick="importSteam()">Link Steam</button>
            <p id="steam-status"></p>

            <h3>Game Preferences</h3>
            <div class="checkbox-group">
                <label><input type="checkbox" value="Action"> Action</label>
                <label><input type="checkbox" value="Adventure"> Adventure</label>
                <label><input type="checkbox" value="Indie"> Indie</label>
                <label><input type="checkbox" value="RPG"> RPG</label>
                <label><input type="checkbox" value="Strategy"> Strategy</label>
                <label><input type="checkbox" value="Puzzle"> Puzzle</label>
            </div>
            <button onclick="savePreferences()">Save</button>

            <h3>Account</h3>
            <input type="text" id="gamer-tag" placeholder="Gamer Tag">
            <button onclick="saveAccount()">Update</button>

            <button class="close-btn" onclick="closeProfile()">Close</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        let currentGame = null;
        let currentRating = 0;
        let playedGames = JSON.parse(localStorage.getItem("played")) || [];
        let reviews = JSON.parse(localStorage.getItem("reviews")) || {};
        let user = JSON.parse(localStorage.getItem("user")) || { gamer_tag: "Guest" };

        async function getRandomGame() {
            const res = await fetch("/game/random");
            const game = await res.json();
            if (game.error) { alert(game.error); return; }
            displayGame(game);
        }

        function displayGame(game) {
            currentGame = game;
            document.getElementById("game-title").textContent = game.name;
            document.getElementById("game-image").src = game.image;
            document.getElementById("price").textContent = game.price || "N/A";
            document.getElementById("release").textContent = game.release_date || "TBA";
            document.getElementById("review_summary").textContent = game.review_summary || "N/A";
            document.getElementById("genres").textContent = game.genres?.join(", ") || "N/A";

            // Load saved review
            const saved = reviews[game.appid];
            if (saved) {
                document.getElementById("modal-status").textContent = "You rated this " + saved.rating + " stars!";
            }
        }

        function markPlayed() {
            if (currentGame && !playedGames.includes(currentGame.appid)) {
                playedGames.push(currentGame.appid);
                localStorage.setItem("played", JSON.stringify(playedGames));
                alert("Marked as played!");
            }
        }

        // === RATING MODAL ===
        function openRateModal() {
            if (!currentGame) return;
            document.getElementById("modal-game-title").textContent = currentGame.name;
            document.getElementById("rate-modal").style.display = "flex";
            resetStars();
            const saved = reviews[currentGame.appid];
            if (saved) {
                setRating(saved.rating);
                document.getElementById("modal-review-text").value = saved.text || "";
            } else {
                document.getElementById("modal-review-text").value = "";
            }
        }

        function closeRateModal() {
            document.getElementById("rate-modal").style.display = "none";
        }

        function setRating(rating) {
            currentRating = rating;
            const stars = document.querySelectorAll("#rate-modal .star");
            stars.forEach((star, i) => {
                star.classList.toggle("active", i < rating);
            });
        }

        function resetStars() {
            currentRating = 0;
            document.querySelectorAll("#rate-modal .star").forEach(s => s.classList.remove("active"));
        }

        function submitRating() {
            if (currentRating === 0) {
                alert("Please select a star rating!");
                return;
            }
            const text = document.getElementById("modal-review-text").value.trim();
            reviews[currentGame.appid] = { rating: currentRating, text };
            localStorage.setItem("reviews", JSON.stringify(reviews));
            document.getElementById("modal-status").textContent = "Rating saved!";
            markPlayed();
        }

        // === FILTERS ===
        function applyFilters() { alert("Filters applied!"); getRandomGame(); }
        function resetFilters() { document.querySelectorAll("input[type=checkbox], select").forEach(el => el.type === "checkbox" ? el.checked = false : el.value = ""); }

        // === PROFILE ===
        function openProfile() {
            document.getElementById("profile-modal").style.display = "flex";
            document.getElementById("steam-id").value = user.steam_id || "";
            document.getElementById("gamer-tag").value = user.gamer_tag;
        }
        function closeProfile() { document.getElementById("profile-modal").style.display = "none"; }

        function importSteam() {
            const id = document.getElementById("steam-id").value.trim();
            if (id) { user.steam_id = id; localStorage.setItem("user", JSON.stringify(user)); }
            document.getElementById("steam-status").textContent = id ? "Steam linked!" : "";
        }
        function savePreferences() { alert("Preferences saved!"); }
        function saveAccount() {
            const tag = document.getElementById("gamer-tag").value.trim();
            if (tag) { user.gamer_tag = tag; localStorage.setItem("user", JSON.stringify(user)); alert("Gamer tag updated!"); }
        }

        window.onload = getRandomGame;
    </script>
</body>
</html>